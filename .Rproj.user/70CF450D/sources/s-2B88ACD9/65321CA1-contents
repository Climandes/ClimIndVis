#########################
##### autoplot_climatology_map
#########################

###### topographie mit aufnehmen!!!


#->> add an excericse on the fine differences of the arguments. e.g.spells_can_span_years oder rr threshold = 0.1 oder = 1

# Como su nombre lo indica, podemos utilizar la función autoplot_climatology_map para visualizar la climatología de un indicador.
# Esta función funciona tanto para datos puntuales como para datos grillados y podemos mostrar ambos tipos de datos en el mismo gráfico.
# La construcción de cada función autoplot.... es similar.
# De nuevo tenemos los argumentos para los datos (dat_p y dat_grid esta vez), un index y index_args.

# Necesitamos entonces nuestros datos grillados y datos de puntos.
# Del codigo de la práctica autoplot_overview_stations tenemos climindvis_obs, entonces cargamos climindvis_grid.
# Para esto necesitamos también el paquete ncdf4

library(ncdf4)

(dir <- getwd())
path <- paste0(dir, "/Carpeta/u1/piscop_daily/Pisco_diario_1981-2015_eragrid.nc")
data_name <- "PISCO SUR ERAGRID"
climindvis_grid <- get_grid_object(path = path, data_name = data_name)

?autoplot_climatology_map

# Ya conocemos bien los dos argumentos index y index_args.
# En este caso, de nuevo sólo es posible especificar un indicador y una lista con sus argumentos necesarios.
# Además, autoplot_climatology_map tiene la posibilidad de especificar plot_value.
# Con este argumento se puede especificar, por ejemplo, si se desea visualizar la media o la desviación estándar.

index <- "prcptot"
index_args <- list(aggt="dates", start_days="0000-09-15", end_days = "0000-10-15")

autoplot_climatology_map(dat_grid = climindvis_grid, dat_p = climindvis_obs, index = index, index_args= index_args,
                         plot_value = "mean")

autoplot_climatology_map(dat_grid = climindvis_grid, dat_p = climindvis_obs, index = index, index_args= index_args,
                         plot_value = "sd")

# Este gráfico calcula la climatología para todo el período.
# Sin embargo, es posible tomar sólo una cierta selección de años.
# Por ejemplo, podemos calcular la suma de precipitaciones para todos los años de La Niña.

selyears <- c(1985,1989,1996,2000,2001,2006,2008,2009)

# ----- question
# ¿Cómo imaginas la desviación estándar si sólo miras los años de La Niña?

# un poco más alta
# un poco más baja
# más variabilidad espacial

# en este momento no es posible visualizars los dos graficos al mismo tiempo (p. ej. con par(mfrow=c(1,2))),
# porque la función autoplot abra para llamada una nueva "device".
#  Para evitar esto, abrimos dos dispositivos con el argumento Output.
autoplot_climatology_map(dat_grid = climindvis_grid, dat_p = climindvis_obs, index = index, index_args= index_args,
                         plot_value = "sd", output= "dev.new")

# Esto nos da una desviación estándar de las sumas de precipitación un poco más baja de las sumas de precipitación.


index <- "rainy_season_start"
index_args1 <- list(aggt="dates", start_days="0000-07-15", end_days = "0000-12-31",rs_method="garcia")
index_args2 <- list(aggt="dates", start_days="0000-07-15", end_days = "0000-12-31",rs_method="stern")
index_args3 <- list(aggt="dates", start_days="0000-07-15", end_days = "0000-12-31",rs_method="gurgiser")
index_args4 <- list(aggt="dates", start_days="0000-07-15", end_days = "0000-12-31",rs_method="consec_th", days=7,th=20)

# también podemos añadir la topografia
autoplot_climatology_map(dat_grid = climindvis_grid, dat_p = climindvis_obs, index = index, index_args= index_args,
                         plot_value = "mean")
